# Description: Linux Kernel binaries for Samsung Chromebook
# URL: https://chromium.googlesource.com/chromiumos/
# Maintainer: CRUX-ARM System Team, devel at crux-arm dot nu
# Depends on: gcc4 dtc u-boot-tools

name=kernel-chromeos-3.4
version=3.4.0
release=1

source=(config-$version \
    kernel.its \
    timeconst.patch \
    negative.patch \
    mac80211.patch)

build() {
  # Get sources
  if [ ! -d $PKGMK_SOURCE_DIR/chromeos-3.4 ]; then
    git clone https://chromium.googlesource.com/chromiumos/third_party/kernel.git -b chromeos-3.4 --depth 1 $PKGMK_SOURCE_DIR/chromeos-3.4
    # Apply patches
    patch -p1 < $SRC/negative.patch
    patch -p1 < $SRC/mac80211.patch
    patch -p1 < $SRC/timeconst.patch
    # Fix bad include
    #sed -i "s|#include <udl_connector.h>|#include \"udl_connector.h\"|g" drivers/gpu/drm/udl/udl_connector.c
  fi

  cd $PKGMK_SOURCE_DIR/chromeos-3.4
  cp $SRC/config-$version .config
  cp $SRC/kernel.its .

  # Disable LSM
  sed -i 's/CONFIG_SECURITY_CHROMIUMOS=y/# CONFIG_SECURITY_CHROMIUMOS is not set/g' .config

  # uImage
  make CC=/usr/gcc-4.8.5/bin/gcc -j$(cat /proc/cpuinfo|grep processor | wc -l) uImage zImage

  # Modules
  make CC=/usr/gcc-4.8.5/bin/gcc -j$(cat /proc/cpuinfo|grep processor | wc -l) modules
  make CC=/usr/gcc-4.8.5/bin/gcc modules_install INSTALL_MOD_PATH=$PKG
  rm -f $PKG/lib/modules/$version/{source,build}

  # DBTs
  make CC=/usr/gcc-4.8.5/bin/gcc dtbs

  # FIT image
  mkimage -f kernel.its vmlinux.uimg

  # Place it at /boot
  install -d -m 0755 $PKG/boot
  cp vmlinux.uimg $PKG/boot/vmlinux.uimg
}
