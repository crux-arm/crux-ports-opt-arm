# Description: The Mozilla Firefox browser
# URL: http://www.mozilla.com/firefox/
# Maintainer: Fredrik Rinnestam, fredrik at crux dot nu
# Arch Maintainer: CRUX-ARM System Team, devel at crux-arm dot nu
# Depends on: nss, libidl, gtk, python, alsa-lib, yasm, mesa3d

name=firefox
version=25.0.1
release=1
source=(ftp://ftp.mozilla.org/pub/firefox/releases/$version/source/firefox-$version.source.tar.bz2
        mozconfig firefox.desktop)

build() {
  export MOZ_CO_PROJECT=browser
  export BUILD_OFFICIAL=1
  export MOZILLA_OFFICIAL=1
  export MOZILLA_FIVE_HOME=/usr/lib/firefox

  cd mozilla-release

  sed -e "s/#CFLAGS#/$CFLAGS/" $SRC/mozconfig > .mozconfig
  ./configure

  mkdir $SRC/mozilla-release/js/src/.deps

  make

  install -d \
    $PKG$MOZILLA_FIVE_HOME \
    $PKG/usr/bin \
    $PKG/usr/share/idl/firefox \
    $PKG/usr/include/firefox

  cp -rL dist/bin/* $PKG$MOZILLA_FIVE_HOME
  ln -s /usr/lib/firefox/firefox $PKG/usr/bin/firefox

  # devel stuff
  cp -frL dist/idl/* $PKG/usr/share/idl/firefox/
  cp -frL dist/include/* $PKG/usr/include/firefox/

  install -d $PKG/etc/ld.so.conf.d
  echo "/usr/lib/$name" > $PKG/etc/ld.so.conf.d/$name.conf

  # cleanup
  #find $PKG -name .mkdir.done -delete
  find $PKG -type f -empty -delete
  # desktop stuff
  mkdir -p $PKG/usr/share/pixmaps
  ln -s /usr/lib/firefox/browser/chrome/browser/content/branding/icon48.png $PKG/usr/share/pixmaps/firefox_default48.png
  install -D -m 0644 $SRC/firefox.desktop $PKG/usr/share/applications/firefox.desktop
}
